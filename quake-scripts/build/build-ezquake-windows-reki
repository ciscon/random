#!/bin/bash
# force=1 to skip revision check

set -e

ezquake_config='
CFLAGS=-m32 -O2 -msse2 -mfpmath=sse -g0 -D_DEBUG -D_WIN32_WINNT=0x0501 -D__USE_MINGW_ANSI_STDIO -DWITH_WINAMP -Imingw32-libs/include -Wall -Wno-pointer-to-int-cast -Wno-int-to-pointer-cast -Wno-strict-aliasing -Werror=strict-prototypes -Werror=old-style-definition -MMD
GCCVERSION=$(shell gcc -dumpversion)
LDFLAGS=-Lmingw32-libs/lib -L/usr/lib/gcc/i686-w64-mingw32/$(GCCVERSION)-posix -static
ZLIB_LIBS=-lz
SDL2_CFLAGS=-Imingw32-libs/include/SDL2
SDL2_LIBS=-lSDL2 -lole32 -limm32 -lcomctl32 -lversion -loleaut32
PCRE_CFLAGS=-DPCRE_STATIC
PCRE_LIBS=-lpcre
CURL_CFLAGS=-DCURL_STATICLIB
CURL_LIBS=-lcurl -lcrypt32
SPEEX_LIBS=-lspeex -lspeexdsp
EXPAT_CFLAGS=
EXPAT_LIBS=-lexpat
PNG_CFLAGS=-DWITH_PNG -DWITH_PNG_STATIC -Imingw32-libs/include/libpng16
PNG_LIBS=-lpng16
JPEG_CFLAGS=-DWITH_JPEG -DWITH_JPEG_STATIC
JPEG_LIBS=-ljpeg
JANSSON_CFLAGS=
JANSSON_LIBS=-ljansson
SNDFILE_CFLAGS=
SNDFILE_LIBS=-lsndfile
CONFIG_WINDOWS=y
CC=clang -target i686-w64-mingw32
WINDRES=i686-w64-mingw32-windres
STRIP=i686-w64-mingw32-strip
FREETYPE_CFLAGS=
FREETYPE_LIBS=
'

unset CC
export CFLAGS=" -fcommon "
export LDFLAGS="$CFLAGS"

bindir="/mnt/nas-quake/binaries/win/ezquake"
buildroot="/tmp/build"
gitdir="${buildroot}/ezquake-source-reki"
gitrepo="https://github.com/Iceman12k/ezquake-source.git"
#using purely to check revision
remotehead=$(git ls-remote "$gitrepo" HEAD|head -1|awk '{print $1}'|cut -c1-6)

if [ -z "$remotehead" ];then
  echo "couldn't retrieve remote head"
  exit 1
fi

mkdir -p "$buildroot"

if [ "$force" != "1" ];then
  #check whether or not we need to proceed
  for bin in "${bindir}/"ezquake-reki-*-??????.zip;do
    temprev=$(echo "$bin"|awk -F'[.-]' '{print $(NF-1)}')
    if [ "$temprev" = "$remotehead" ];then
      echo "revision already built, exiting."
      exit 0
    fi
  done
fi

if [ ! -d "$gitdir" ];then
  git clone "$gitrepo" "$gitdir" || exit 1
fi

cd "$gitdir"
git checkout master > /dev/null 2>&1
git reset --hard origin/master >/dev/null 2>&1
git clean -qfdx >/dev/null 2>&1
git pull >/dev/null 2>&1
#just in case it's changed since remote pull
VERSION=$(sed -n 's/.*VERSION_NUMBER.*"\(.*\)".*/\1/p' version.h)
REVISION=$(git log -n 1|head -1|awk '{print $2}'|cut -c1-6)

rm -f *.exe
rm -f *.zip
make clean
if [ ! -f .config_windows-clang ];then
	echo "$ezquake_config" > .config_windows-clang
fi
sed -i 's/^CFLAGS=/CFLAGS+=/g' .config_windows-clang
sed -i 's/^LDFLAGS=/LDFLAGS+=/g' .config_windows-clang

if [ -d output ];then
        rm -rf output
fi
mkdir -p output
make clean;sync;CLASSIC_OPENGL_ONLY=1 EZ_CONFIG_FILE=.config_windows-clang nice make -j$(nproc)
mv *.exe output/.
echo "classic done"
make clean;sync;MODERN_OPENGL_ONLY=1 EZ_CONFIG_FILE=.config_windows-clang nice make -j$(nproc)
mv *.exe output/.
echo "modern done"

zip -9 -j -r "ezquake-reki-${VERSION}-${REVISION}.zip" output/*.exe

if [ $? -eq 0 ];then
  if [ -d  "$bindir" ];then
    ln -sf *.zip ezquake-reki-latest.zip && cp -Pf --remove-destination *.zip "$bindir/"
  else
    echo "$bindir not found, bailing out."
    exit 1
  fi
else
  echo "something failed, bailing out."
  exit 1
fi

echo "ezquake-reki binary created successfully and copied to $bindir"
make clean
exit 0
