#!/bin/bash

iterations=5
exe="quake"
demo="fps4"
demofps= #empty for default of 308

#reset all config options for run
extra="+cfg_reset +gl_no24bit 1 +gl_externaltextures_world 0 +gl_externaltextures_bmodels 0 +gl_multisamples 0 +gl_anisotropy 0 +gl_texturemode gl_nearest_mipmap_linear +r_smoothcrosshair 0 +r_smoothimages 0 +r_smoothtext 0 -nosound +sys_highpriority 1 -no-triple-gl-buffer"
tmpoutput="/tmp/quakebenchoutput"

echo -e "running $iterations timedemos of ${demo}...\n"

echo > $tmpoutput

jobs=()
trap 'kill "${jobs[@]}"' EXIT


tail -F $tmpoutput |\
	while IFS= read -r line; do
		echo "$line"|grep -i '.*frames.*seconds.*fps' >/dev/null 2>&1 && echo quit > /tmp/ezquake_fifo_$(id -u -n)
	done&
jobs+=($!)

tail -F $tmpoutput|grep '.*frames.*seconds.*fps' &
jobs+=($!)

let count=0
while [ $count -lt $iterations ]; do
	$exe $extra +timedemo2 demos/$demo $demofps -condebug /dev/stdout >> $tmpoutput 2>&1 || break
	let count=count+1
done

#get system info
gpu=$(sed -n '/^OpenGL.\+/,/^\s*Version:/{/Version:/{q}};s/.*Renderer:\s*\(.*\)/\1/p' $tmpoutput | head -n1)
cpu=$(sed -n 's/^model name\s*:\s*\(.*\)$/\1/p' /proc/cpuinfo | head -n1)
res=$(sed -n '/^Video.\+/,/^\s*Resolution:/{/Format:/{q}};s/.*Resolution:\s*\(.*\)/\1/p' $tmpoutput | head -n1)

echo ""

echo "CPU: ${cpu:-NA}"
echo "GPU: ${gpu:-NA}"
echo "Resolution: ${res:-NA}"

exit 0
